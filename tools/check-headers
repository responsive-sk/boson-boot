#!/usr/bin/env php
<?php
/**
 * Simple Header Check Script
 * Checks for common causes of malformed headers
 */

echo "🔍 Checking for malformed header causes...\n\n";

// Check critical files for BOM and encoding issues
$files = [
    'public/index.php',
    'src/Shared/Infrastructure/Http/Kernel.php',
    'src/Shared/Infrastructure/Environment.php'
];

foreach ($files as $file) {
    if (file_exists($file)) {
        $content = file_get_contents($file);
        
        echo "Checking $file:\n";
        
        // Check for BOM
        if (substr($content, 0, 3) === "\xEF\xBB\xBF") {
            echo "  ❌ BOM detected!\n";
        } else {
            echo "  ✅ No BOM\n";
        }
        
        // Check first bytes
        $firstBytes = bin2hex(substr($content, 0, 10));
        echo "  First bytes: $firstBytes\n";
        
        // Check if starts with <?php
        if (substr($content, 0, 5) === '<?php') {
            echo "  ✅ Starts with <?php\n";
        } else {
            echo "  ❌ Does not start with <?php\n";
            echo "  Actual start: " . bin2hex(substr($content, 0, 20)) . "\n";
        }
        
        echo "\n";
    } else {
        echo "❌ File not found: $file\n\n";
    }
}

echo "💡 If BOM detected, remove it with:\n";
echo "   sed -i '1s/^\xEF\xBB\xBF//' filename.php\n\n";

echo "💡 Common fixes:\n";
echo "  1. Remove BOM from all PHP files\n";
echo "  2. Check for whitespace before <?php\n";
echo "  3. Ensure UTF-8 without BOM encoding\n";
echo "  4. Check templates for binary data\n";
