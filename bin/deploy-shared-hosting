#!/usr/bin/env php
<?php
/**
 * Quick Deploy to Shared Hosting
 * One-command build and package for shared hosting
 * 
 * Usage: ./bin/deploy-shared-hosting [version]
 */

$version = $argv[1] ?? date('Y-m-d-H-i-s');
$buildDir = "build-$version";
$packageName = "boson-php-$version";

echo "ğŸš€ Quick Deploy to Shared Hosting\n";
echo "==================================\n";
echo "Version: $version\n";
echo "Build dir: $buildDir\n";
echo "Package: $packageName.tar.gz\n\n";

// Step 1: Build
echo "1ï¸âƒ£  Building application...\n";
$buildCommand = __DIR__ . "/build-shared-hosting '$buildDir'";
$buildResult = shell_exec($buildCommand . ' 2>&1');

if (!is_dir($buildDir)) {
    echo "âŒ Build failed!\n";
    echo $buildResult;
    exit(1);
}
echo "âœ… Build completed\n\n";

// Step 2: Package
echo "2ï¸âƒ£  Creating package...\n";
$packageCommand = __DIR__ . "/package-for-upload '$buildDir' '$packageName'";
$packageResult = shell_exec($packageCommand . ' 2>&1');

if (!file_exists("$packageName.tar.gz")) {
    echo "âŒ Packaging failed!\n";
    echo $packageResult;
    exit(1);
}
echo "âœ… Package created\n\n";

// Step 3: Create deployment summary
echo "3ï¸âƒ£  Creating deployment summary...\n";

$deploymentSummary = "# Boson PHP Deployment Summary
Version: $version
Created: " . date('Y-m-d H:i:s') . "
Package: $packageName.tar.gz

## What's Included:
- âœ… Production-optimized index.php
- âœ… Security-hardened .htaccess
- âœ… Complete source code (src/, templates/)
- âœ… Vendor dependencies
- âœ… Storage directories with protection
- âœ… Maintenance scripts
- âœ… Environment template
- âœ… Deployment documentation

## Production Optimizations Applied:
- ğŸ”’ Error reporting disabled
- ğŸ”’ Xdebug disabled
- ğŸ”’ Security headers added
- ğŸ”’ Dangerous PHP functions disabled
- âš¡ Output buffering enabled
- âš¡ Compression enabled
- âš¡ Browser caching configured
- ğŸ“ Storage directories protected

## Upload Instructions:
1. Upload $packageName.tar.gz to your hosting
2. Extract in your account root
3. Move public_html/ contents to your domain folder
4. Move other files to private directory
5. Configure .env file
6. Set proper permissions
7. Test application

## Quick Commands for Server:
```bash
# Extract
tar -xzf $packageName.tar.gz

# Move files (adjust paths for your hosting)
mv public_html/* /path/to/your/domain/
mv src/ templates/ vendor/ storage/ ../
mv .env.production ../.env

# Set permissions
chmod 755 /path/to/your/domain/
chmod 644 /path/to/your/domain/.htaccess
chmod -R 755 ../storage/

# Configure
cd ..
nano .env  # Edit with your settings
```

## Support:
- Read DEPLOYMENT.md for detailed instructions
- Check storage/logs/ for error logs
- Use maintenance/ scripts for upkeep

Ready for production deployment! ğŸš€
";

file_put_contents("DEPLOYMENT-SUMMARY-$version.md", $deploymentSummary);
echo "âœ… Deployment summary created\n\n";

// Step 4: Final summary
$packageSize = round(filesize("$packageName.tar.gz") / 1024 / 1024, 2);

echo "ğŸ‰ Deployment Package Ready!\n";
echo "============================\n";
echo "ğŸ“¦ Package: $packageName.tar.gz ({$packageSize} MB)\n";
echo "ğŸ“‹ Summary: DEPLOYMENT-SUMMARY-$version.md\n";
echo "ğŸ“– Instructions: UPLOAD-INSTRUCTIONS.txt\n\n";

echo "ğŸ“¤ Next Steps:\n";
echo "1. Upload $packageName.tar.gz to your shared hosting\n";
echo "2. Follow instructions in UPLOAD-INSTRUCTIONS.txt\n";
echo "3. Configure .env with your settings\n";
echo "4. Test your application\n\n";

echo "ğŸ” Files created:\n";
echo "- $buildDir/ (build directory)\n";
echo "- $packageName.tar.gz (upload package)\n";
echo "- DEPLOYMENT-SUMMARY-$version.md (summary)\n";
echo "- UPLOAD-INSTRUCTIONS.txt (instructions)\n\n";

echo "âœ¨ Happy deploying! âœ¨\n";
