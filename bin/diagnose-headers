#!/usr/bin/env php
<?php
/**
 * Comprehensive Header Diagnosis Script
 * Diagnoses and provides solutions for malformed HTTP headers
 */

echo "üîç Comprehensive Header Diagnosis\n";
echo "=================================\n\n";

// Test 1: Check output buffering
echo "1. Testing output buffering...\n";
if (ob_get_level() > 0) {
    echo "‚ö†Ô∏è  Output buffering is active (level: " . ob_get_level() . ")\n";
} else {
    echo "‚úÖ No output buffering detected\n";
}

// Test 2: Check for premature output
echo "\n2. Checking for premature output...\n";
ob_start();
echo "test";
$output = ob_get_contents();
ob_end_clean();

if (!empty($output)) {
    echo "‚úÖ Output buffering works correctly\n";
} else {
    echo "‚ùå Output buffering issue detected\n";
}

// Test 3: Check PHP configuration
echo "\n3. Checking PHP configuration...\n";
echo "  PHP Version: " . PHP_VERSION . "\n";
echo "  Output buffering: " . (ini_get('output_buffering') ? 'ON' : 'OFF') . "\n";
echo "  Implicit flush: " . (ini_get('implicit_flush') ? 'ON' : 'OFF') . "\n";
echo "  Zlib compression: " . (ini_get('zlib.output_compression') ? 'ON' : 'OFF') . "\n";

// Test 4: Check for problematic extensions
echo "\n4. Checking loaded extensions...\n";
$problematicExtensions = ['xdebug', 'newrelic', 'blackfire'];
$loadedExtensions = get_loaded_extensions();

foreach ($problematicExtensions as $ext) {
    if (in_array($ext, $loadedExtensions)) {
        echo "  ‚ö†Ô∏è  $ext is loaded (can cause output issues)\n";
    }
}

// Test 5: Test minimal response
echo "\n5. Testing minimal HTTP response...\n";
$testFile = 'test_response.php';
file_put_contents($testFile, '<?php header("Content-Type: text/plain"); echo "OK"; ?>');

$response = shell_exec("php $testFile 2>&1");
unlink($testFile);

if (trim($response) === 'OK') {
    echo "‚úÖ Basic PHP response works\n";
} else {
    echo "‚ùå Basic PHP response failed\n";
    echo "  Response: " . bin2hex(substr($response, 0, 50)) . "\n";
}

echo "\nüéØ Recommended Solutions:\n";
echo "=============================\n";
echo "1. Clear all caches: ./tools/cache-manager clear\n";
echo "2. Disable problematic PHP extensions temporarily\n";
echo "3. Check server configuration (Apache/Nginx)\n";
echo "4. Add output buffering control to index.php:\n";
echo "   ob_start();\n";
echo "   // your code\n";
echo "   ob_end_flush();\n";
echo "\n5. Add error suppression for production:\n";
echo "   error_reporting(0);\n";
echo "   ini_set('display_errors', 0);\n";

echo "\nüîß Quick Fix Commands:\n";
echo "======================\n";
echo "./tools/cache-manager clear  # Clear caches\n";
echo "./bin/fix-bom                # Remove BOM\n";
echo "systemctl restart php-fpm   # Restart PHP-FPM\n";
echo "systemctl restart apache2   # Restart Apache\n";
